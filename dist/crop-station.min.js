"use strict";var CropStation=function(){function d(){this._root.style.display="none"}function _(t){this._desk.querySelector(".execute").style.display=this._desk.querySelector(".cancel").style.display=t?"inline-block":"none"}function x(){this._cropBox.style.display="none"}function g(t){"crop"===t&&(this._cropBox.querySelector(".value_W").innerText=(parseFloat(this._cropBox.style.width)/this.ratio).toFixed(2),this._cropBox.querySelector(".value_H").innerText=(parseFloat(this._cropBox.style.height)/this.ratio).toFixed(2))}function v(){this._plateImageBox.style.width=this._imageMetaSize.width*this.ratio+"px",this._plateImageBox.style.height=this._imageMetaSize.height*this.ratio+"px"}function n(t,e,i,s){var o=document.createElement("canvas"),n=o.getContext("2d");o.width=i.width,o.height=i.height,n.drawImage(t,e.x,e.y,o.width,o.height,0,0,o.width,o.height);var a=o.toDataURL("image/jpeg",.5);o.toBlob(function(t){t=new File([t],"new-image.png");s&&s({file:t,bs64:a})},"image/jpeg",.5)}function y(){var e=this,t=parseFloat(this._cropBox.style.width)/this.ratio,i=parseFloat(this._cropBox.style.height)/this.ratio,s=parseFloat(this._cropBox.style.left)-parseFloat(this._plateImageBox.style.left),o=parseFloat(this._cropBox.style.top)-parseFloat(this._plateImageBox.style.top);n(this._image,{x:s,y:o},{width:t,height:i},function(t){e._bs64=t.bs64,e._file=t.file;t=document.createElement("img");t.src=e._bs64,function(t){var e=this;this._image&&(this._plateImageBox.removeChild(this._image),this._image=null);l(t,function(t){e._imageMetaSize={width:t.width,height:t.height},a.call(e),v.call(e),u.call(e),e._plateImageBox.appendChild(e._image=t.element)})}.call(e,t)})}function a(){window.innerWidth>=this._imageMetaSize.width?this.ratio=1:this.ratio=window.innerWidth/this._imageMetaSize.width}function u(){var t=(window.innerWidth-parseFloat(this._plateImageBox.style.width))/2,e=(window.innerHeight-parseFloat(this._plateImageBox.style.height))/2;this._plateImageBox.style.left=(0<=t?t:0)+"px",this._plateImageBox.style.top=(0<=e?e:0)+"px"}function l(t,i){var e,s;t instanceof File?((e=new FileReader).readAsDataURL(t),e.onload=function(t){var e=document.createElement("img");e.src=t.target.result,e.onload=function(){i&&i({element:e,width:e.width,height:e.height})}}):t instanceof Image&&((s=document.createElement("img")).onload=function(){i&&i({element:s,width:s.width,height:s.height})},s.src=t.src)}function m(t){var e=this;this._image&&(this._plateImageBox.removeChild(this._image),this._image=null),l(t,function(t){e._imageMetaSize={width:t.width,height:t.height},a.call(e),v.call(e),u.call(e),e._plateImageBox.appendChild(e._image=t.element),n(t.element,{x:0,y:0},{width:t.width,height:t.height},function(t){e._bs64=t.bs64,e._file=t.file})})}return function(t){var e,i,s,o,n,a,l,c,h=this,t=document.querySelector(t);function r(t){t.stopPropagation();var e=t.clientX-n,t=t.clientY-a;s(c,{x:e,y:t},l)}function p(t){t.stopPropagation(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",p),o&&o()}t.innerHTML='<div class="crop_layout">\n              <div class="desktop">\n                  <div class="operate-box">\n                        <div class="plate_image-box">\n                                <div class="resize-box" style="display:none;">\n                                    <div class="resize_corner_top_left"></div>\n                                    <div class="resize_corner_top_right"></div>\n                                    <div class="resize_corner_bottom_left"></div>\n                                    <div class="resize_corner_bottom_right"></div>\n                                    \x3c!-- 悬浮框展示剪切框大小 --\x3e\n                                    <div class="tooltip_box">\n                                        <div>\n                                            <span class="key">W</span>\n                                            <span>:</span>\n                                            <span class="value_W">0</span> PX\n                                        </div>\n                                        <div>\n                                            <span class="key">H</span>\n                                            <span>:</span>\n                                            <span class="value_H">0</span> PX\n                                        </div>\n                                    </div>\n                            </div>\n                        </div>\n                      <div class="crop-box" style="display:none;">\n                        \x3c!-- 悬浮框展示剪切框大小 --\x3e\n                        <div class="tooltip-box">\n                            <div>\n                            <span class="key">W</span>\n                            <span>:</span>\n                            <span class="value_W">0</span> PX\n                            </div>\n                            <div>\n                            <span class="key">H</span>\n                            <span>:</span>\n                            <span class="value_H">0</span> PX\n                            </div>\n                        </div>\n                        \x3c!-- 填充盒子，撑起框的样式 --\x3e\n                        <div class="frame-box">\n                            <div class="horizontal"></div>\n                            <div class="vertical"></div>\n                        </div>\n                      \n                        \x3c!-- 线上的四个中位点 --\x3e\n                        <div class="inline_dot-box">\n                            <div class="inline_dot left"></div>\n                            <div class="inline_dot right"></div>\n                            <div class="inline_dot top"></div>\n                            <div class="inline_dot bottom"></div>\n                        </div>\n                      \n                        \x3c!-- 覆盖技术:遮盖住前面所有的同级元素，可忽略其他兄弟元素的事件... --\x3e\n                        \x3c!-- 操作句柄 盒子--\x3e\n                        <div class="handle-box">\n                            <div class="resize_line_left"></div>\n                            <div class="resize_line_right"></div>\n                            <div class="resize_line_top"></div>\n                            <div class="resize_line_bottom"></div>\n            \n                            <div class="resize_corner_top_left"></div>\n                            <div class="resize_corner_top_right"></div>\n                            <div class="resize_corner_bottom_left"></div>\n                            <div class="resize_corner_bottom_right"></div>\n                        </div>\n                  </div>\n                  </div>\n                  <div class="top_bar-box">\n                    <div class="btn-group">\n                      <button style="display:none;" class="execute iconfont icon-tick"></button>\n                      <button style="display:none;" class="cancel iconfont icon-cancel"></button>\n                    </div>\n                    <button class="close iconfont icon-Close"></button>\n                  </div>\n                  \n                  <div class="bottom_bar-box">\n                    <button class="zoom-out iconfont icon-plus"></button>\n                    <button class="zoom-in iconfont icon-suoxiao"></button>\n                    <button class="crop iconfont icon-crop"></button>\n                  </div>\n              </div>\n          </div>',this._root=t,this._desk=t.querySelector(".desktop"),this._operate=t.querySelector(".operate-box"),this._plateImageBox=this._operate.querySelector(".plate_image-box"),this._cropBox=this._operate.querySelector(".crop-box"),this._resizeBox=this._operate.querySelector(".resize-box"),d.call(this),this.open=function(){this._root.style.display="block"}.bind(this),this.insertImage=m,function(t){var e=window.getComputedStyle(t);if("absolute"!=e.position&&"fixed"!=e.position)throw"you should only convert position element";t.style.left=isNaN(parseFloat(e.left))?"0px":e.left,t.style.top=isNaN(parseFloat(e.top))?"0px":e.top,t.style.width=isNaN(parseFloat(e.width))?"0px":e.width,t.style.height=isNaN(parseFloat(e.height))?"0px":e.height}(this._cropBox),e=this._cropBox,i=null,s=function(t,e,i){var s=h._cropBox;if(i.classList.contains("handle-box"))s.style.left=t.left+e.x+"px",s.style.top=t.top+e.y+"px";else{switch(i.className){case"resize_line_left":s.style.left=t.left+e.x+"px",s.style.width=t.width-e.x+"px";break;case"resize_line_top":s.style.top=t.top+e.y+"px",s.style.height=t.height-e.y+"px";break;case"resize_line_right":s.style.width=t.width+e.x+"px";break;case"resize_line_bottom":s.style.height=t.height+e.y+"px";break;case"resize_corner_top_left":s.style.left=t.left+e.x+"px",s.style.top=t.top+e.y+"px",s.style.width=t.width-e.x+"px",s.style.height=t.height-e.y+"px";break;case"resize_corner_top_right":s.style.top=t.top+e.y+"px",s.style.width=t.width+e.x+"px",s.style.height=t.height-e.y+"px";break;case"resize_corner_bottom_left":s.style.left=t.left+e.x+"px",s.style.width=t.width-e.x+"px",s.style.height=t.height+e.y+"px";break;case"resize_corner_bottom_right":s.style.width=t.width+e.x+"px",s.style.height=t.height+e.y+"px"}g.call(h,"crop")}},l=a=n=void 0,c={left:0,top:0,width:0,height:0},e.addEventListener("mousedown",function(t){n=t.clientX,a=t.clientY,l=t.target,c.left=parseFloat(e.style.left),c.top=parseFloat(e.style.top),c.width=parseFloat(e.style.width),c.height=parseFloat(e.style.height),i&&Object.assign(c,{data:i()}),t.preventDefault(),t.stopPropagation(),document.addEventListener("mousemove",r),document.addEventListener("mouseup",p)}),window.addEventListener("resize",function(){u.call(h)}),this._desk.addEventListener("click",function(t){t=t.target.classList;t.contains("zoom-in")?(function(){this.ratio=this.ratio<=.1?0:this.ratio-.1,v.call(this),u.call(this)}.call(h),g.call(h,"crop")):t.contains("zoom-out")?(function(){this.ratio+=.1,v.call(this),u.call(this)}.call(h),g.call(h,"crop")):t.contains("crop")?(function(){this._cropBox.style.display="block",this._cropBox.style.width=.6*parseFloat(this._plateImageBox.style.width)+"px",this._cropBox.style.height=.6*parseFloat(this._plateImageBox.style.height)+"px",this._cropBox.style.left=parseFloat(this._plateImageBox.style.left)+.4*parseFloat(this._plateImageBox.style.width)/2+"px",this._cropBox.style.top=parseFloat(this._plateImageBox.style.top)+.4*parseFloat(this._plateImageBox.style.height)/2+"px",g.call(this,"crop")}.call(h),_.call(h,!0)):t.contains("execute")?(y.call(h),x.call(h),_.call(h,!1)):t.contains("cancel")?(x.call(h),_.call(h,!1)):t.contains("close")&&(d.call(h),h.onclose&&h.onclose({file:h._file,bs64:h._bs64}))})}}();